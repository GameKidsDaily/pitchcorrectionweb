import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import * as Tone from "tone";
import { useDropzone } from "react-dropzone";
import { Card, CardContent } from "@/components/ui/card";
import { estimatePitch } from "pitchy";

const keys = Array.from({ length: 88 }, (_, i) => i - 48);
const noteMapping = Object.fromEntries(
  ["A0", "A#0", "B0", "C1", "C#1", "D1", "D#1", "E1", "F1", "F#1", "G1", "G#1", "A1", "A#1", "B1",
   "C2", "C#2", "D2", "D#2", "E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2", "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3", "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5", "C#5", "D5", "D#5", "E5", "F5", "F#5", "G5", "G#5", "A5", "A#5", "B5", "C6", "C#6", "D6", "D#6", "E6", "F6", "F#6", "G6", "G#6", "A6", "A#6", "B6", "C7", "C#7", "D7", "D#7", "E7", "F7", "F#7", "G7", "G#7", "A7", "A#7", "B7", "C8"].map((note, i) => [note, i])
);

export default function PitchCorrectionApp() {
  const [audioBuffer, setAudioBuffer] = useState(null);
  const [notes, setNotes] = useState([]);
  const [adjustedNotes, setAdjustedNotes] = useState({});

  const onDrop = async (acceptedFiles) => {
    const file = acceptedFiles[0];
    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = async () => {
      const buffer = await Tone.getContext().rawContext.decodeAudioData(reader.result);
      setAudioBuffer(buffer);
      analyzeNotes(buffer);
    };
  };

  const analyzeNotes = async (buffer) => {
    const audioContext = new AudioContext();
    const source = audioContext.createBufferSource();
    source.buffer = buffer;
    const analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 2048;
    const dataArray = new Float32Array(analyser.fftSize);
    
    source.start();

    setTimeout(() => {
      analyser.getFloatTimeDomainData(dataArray);
      const [pitch, clarity] = estimatePitch(dataArray, audioContext.sampleRate);
      
      if (clarity > 0.8 && pitch > 0) {
        const closestNote = Tone.Frequency(pitch).toNote();
        setNotes((prevNotes) => [...prevNotes, { note: closestNote, position: noteMapping[closestNote] * 20 }]);
      }
    }, 500);
  };

  const adjustNote = (index, adjustment) => {
    setAdjustedNotes((prev) => ({ ...prev, [index]: (prev[index] || 0) + adjustment }));
  };

  const { getRootProps, getInputProps } = useDropzone({ onDrop, accept: "audio/*" });

  return (
    <div className="p-4 space-y-4">
      <Card>
        <CardContent className="p-4 text-center border-dashed border-2" {...getRootProps()}>
          <input {...getInputProps()} />
          <p>Drag & drop an audio file here, or click to select one</p>
        </CardContent>
      </Card>
      <div className="relative w-[800px] h-[600px] border border-gray-300 bg-white overflow-hidden">
        <div className="grid grid-cols-88 gap-0 border-b">
          {keys.map((_, i) => (
            <div
              key={i}
              className="h-6 border-r border-gray-400 flex items-center justify-center text-xs"
              style={{ backgroundColor: [1, 3, 6, 8, 10].includes(i % 12) ? "black" : "white", color: [1, 3, 6, 8, 10].includes(i % 12) ? "white" : "black" }}
            >
              {Object.keys(noteMapping).find((key) => noteMapping[key] === i)}
            </div>
          ))}
        </div>
        <div className="relative w-full h-full">
          {notes.map((note, index) => (
            <div
              key={index}
              className="absolute left-0 w-full h-6 bg-red-500 opacity-50 flex justify-between items-center px-2"
              style={{ top: `${note.position + (adjustedNotes[index] || 0)}px` }}
            >
              {note.note}
              <div>
                <button onClick={() => adjustNote(index, -5)}>-</button>
                <button onClick={() => adjustNote(index, 5)}>+</button>
              </div>
            </div>
          ))}
        </div>
      </div>
      <div className="flex space-x-4">
        <Button className="mt-4">Apply Correction</Button>
        <Button className="mt-4" onClick={() => Tone.start()}>Preview</Button>
      </div>
    </div>
  );
}
