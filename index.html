import { useState } from "react";
import { Button } from "@/components/ui/button";
import * as Tone from "tone";
import { useDropzone } from "react-dropzone";
import { Card, CardContent } from "@/components/ui/card";
import { estimatePitch } from "pitchy";

export default function AlternativePianoRoll() {
  const [audioBuffer, setAudioBuffer] = useState(null);
  const [notes, setNotes] = useState([]);

  const onDrop = async (acceptedFiles) => {
    const file = acceptedFiles[0];
    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = async () => {
      const buffer = await Tone.getContext().rawContext.decodeAudioData(reader.result);
      setAudioBuffer(buffer);
      analyzeNotes(buffer);
    };
  };

  const analyzeNotes = async (buffer) => {
    const audioContext = new AudioContext();
    const source = audioContext.createBufferSource();
    source.buffer = buffer;
    const analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 2048;
    const dataArray = new Float32Array(analyser.fftSize);
    source.start();

    setTimeout(() => {
      analyser.getFloatTimeDomainData(dataArray);
      const [pitch, clarity] = estimatePitch(dataArray, audioContext.sampleRate);
      
      if (clarity > 0.8 && pitch > 0) {
        setNotes((prevNotes) => [...prevNotes, { frequency: pitch, position: pitch % 100 * 5 }]);
      }
    }, 500);
  };

  const { getRootProps, getInputProps } = useDropzone({ onDrop, accept: "audio/*" });

  return (
    <div className="p-4 space-y-4">
      <Card>
        <CardContent className="p-4 text-center border-dashed border-2" {...getRootProps()}>
          <input {...getInputProps()} />
          <p>Drag & drop an audio file here, or click to select one</p>
        </CardContent>
      </Card>
      <div className="relative w-[800px] h-[600px] border border-gray-300 bg-white overflow-hidden">
        {notes.map((note, index) => (
          <div
            key={index}
            className="absolute left-0 w-full h-6 bg-blue-500 opacity-75"
            style={{ top: `${note.position}px` }}
          >
            ðŸŽµ {note.frequency.toFixed(2)} Hz
          </div>
        ))}
      </div>
      <div className="flex space-x-4">
        <Button className="mt-4">Apply Correction</Button>
        <Button className="mt-4" onClick={() => Tone.start()}>Preview</Button>
      </div>
    </div>
  );
}
